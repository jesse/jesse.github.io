<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Math Adventure</title>
        <style>
            :root {
                --sky: #8fd8ff;
                --sun: #ffd966;
                --grass: #8de07c;
                --ink: #17324d;
                --card: #fffdf7;
                --success: #1b8f4a;
                --error: #c3382b;
                --accent: #ff7d5f;
                --border: #2f5d7f;
            }

            * {
                box-sizing: border-box;
            }

            body {
                margin: 0;
                min-height: 100vh;
                display: grid;
                place-items: center;
                padding: 24px;
                background:
                    radial-gradient(
                        circle at 10% 15%,
                        rgba(255, 255, 255, 0.65) 0 5%,
                        transparent 6%
                    ),
                    radial-gradient(
                        circle at 88% 20%,
                        rgba(255, 255, 255, 0.65) 0 4%,
                        transparent 5%
                    ),
                    radial-gradient(
                        circle at 20% 88%,
                        rgba(255, 255, 255, 0.5) 0 5%,
                        transparent 6%
                    ),
                    linear-gradient(
                        155deg,
                        var(--sun) 0%,
                        var(--sky) 52%,
                        var(--grass) 100%
                    );
                font-family:
                    "Chalkboard SE", "Comic Sans MS", "Marker Felt",
                    "Trebuchet MS", sans-serif;
                color: var(--ink);
            }

            .app {
                width: min(940px, 95vw);
                background: var(--card);
                border: 5px solid var(--border);
                border-radius: 28px;
                box-shadow: 0 20px 40px rgba(23, 50, 77, 0.2);
                padding: clamp(18px, 4vw, 40px);
                animation: pop-in 320ms ease-out;
            }

            h1 {
                margin: 0 0 10px;
                font-size: clamp(2rem, 5vw, 3.4rem);
                text-align: center;
                letter-spacing: 0.02em;
            }

            .subtitle {
                margin: 0;
                text-align: center;
                font-size: clamp(1rem, 2.2vw, 1.4rem);
                font-weight: 700;
            }

            .controls {
                margin: 24px auto 30px;
                background: #e6f8ff;
                border: 3px solid #7bbfda;
                border-radius: 18px;
                padding: 14px 18px 16px;
                max-width: 600px;
            }

            .difficulty-label {
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 12px;
                font-weight: 800;
                font-size: clamp(1.05rem, 2.2vw, 1.35rem);
                margin-bottom: 8px;
            }

            #difficultyValue {
                display: inline-grid;
                place-items: center;
                min-width: 2.2em;
                background: var(--accent);
                color: #fff;
                border: 2px solid #d85736;
                border-radius: 999px;
                padding: 0.18em 0.5em;
            }

            #difficulty {
                width: 100%;
                accent-color: var(--accent);
                cursor: pointer;
            }

            .problem-card {
                background: #fff;
                border: 4px dashed #86b3cf;
                border-radius: 24px;
                padding: clamp(14px, 2.8vw, 30px);
            }

            .problem-form {
                display: flex;
                flex-wrap: wrap;
                align-items: center;
                justify-content: center;
                gap: 14px;
            }

            .equation {
                font-size: clamp(2.2rem, 7vw, 5.4rem);
                font-weight: 900;
                letter-spacing: 0.02em;
                line-height: 1;
            }

            #answer {
                width: clamp(120px, 18vw, 190px);
                padding: 10px 14px;
                font-size: clamp(2rem, 5.8vw, 4rem);
                font-weight: 800;
                text-align: center;
                color: var(--ink);
                border: 4px solid #5f93b7;
                border-radius: 16px;
                background: #f6fbff;
            }

            #answer::placeholder {
                color: #6a8ea8;
                opacity: 0.7;
            }

            #answer:focus-visible,
            #checkBtn:focus-visible,
            #difficulty:focus-visible {
                outline: 4px solid #ffb347;
                outline-offset: 2px;
            }

            #checkBtn {
                border: 0;
                border-radius: 16px;
                background: var(--accent);
                color: #fff;
                font-size: clamp(1.15rem, 2.4vw, 1.8rem);
                font-weight: 900;
                padding: 13px 24px;
                cursor: pointer;
                transition:
                    transform 120ms ease,
                    filter 120ms ease;
            }

            #checkBtn:hover {
                transform: translateY(-2px);
                filter: brightness(1.05);
            }

            .feedback {
                margin: 18px 0 0;
                min-height: 1.4em;
                text-align: center;
                font-size: clamp(1.3rem, 2.7vw, 2rem);
                font-weight: 900;
                opacity: 0;
                transition: opacity 280ms ease;
            }

            .feedback.show {
                opacity: 1;
            }

            .feedback.fade-out {
                opacity: 0;
            }

            .feedback.success {
                color: var(--success);
            }

            .feedback.error {
                color: var(--error);
            }

            .sr-only {
                position: absolute;
                width: 1px;
                height: 1px;
                padding: 0;
                margin: -1px;
                overflow: hidden;
                clip: rect(0, 0, 0, 0);
                white-space: nowrap;
                border: 0;
            }

            @keyframes pop-in {
                from {
                    opacity: 0;
                    transform: scale(0.96) translateY(12px);
                }
                to {
                    opacity: 1;
                    transform: scale(1) translateY(0);
                }
            }

            @media (max-width: 640px) {
                body {
                    padding: 14px;
                }

                .app {
                    border-radius: 20px;
                }

                #checkBtn {
                    width: 100%;
                }
            }
        </style>
    </head>
    <body>
        <main class="app">
            <h1>Math Adventure</h1>

            <section class="controls" aria-label="Difficulty controls">
                <label class="difficulty-label" for="difficulty">
                    <span>Difficulty</span>
                    <span id="difficultyValue">1</span>
                </label>
                <input
                    id="difficulty"
                    type="range"
                    min="1"
                    max="5"
                    step="1"
                    value="1"
                />
            </section>

            <section class="problem-card" aria-label="Math problem area">
                <form class="problem-form" id="problemForm" autocomplete="off">
                    <span id="equation" class="equation">0 + 0 =</span>
                    <label class="sr-only" for="answer">Type your answer</label>
                    <input
                        id="answer"
                        type="text"
                        inputmode="decimal"
                        aria-label="Answer input"
                        placeholder="?"
                    />
                    <button id="checkBtn" type="submit">Submit</button>
                </form>
                <p id="feedback" class="feedback" aria-live="polite"></p>
            </section>
        </main>

        <script>
            const difficultyInput = document.getElementById("difficulty");
            const difficultyValue = document.getElementById("difficultyValue");
            const equationText = document.getElementById("equation");
            const answerInput = document.getElementById("answer");
            const feedbackText = document.getElementById("feedback");
            const problemForm = document.getElementById("problemForm");
            const difficultyStorageKey = "math_difficulty";

            let currentDifficulty = 1;
            let currentProblem = { a: 0, b: 0, op: "+", answer: 0 };
            let recentOperators = [];
            let feedbackFadeTimer = null;
            let feedbackClearTimer = null;

            function randomInt(min, max) {
                return Math.floor(Math.random() * (max - min + 1)) + min;
            }

            function clampDifficulty(value) {
                if (!Number.isInteger(value)) {
                    return 1;
                }
                return Math.min(5, Math.max(1, value));
            }

            function loadSavedDifficulty() {
                let savedValue = 1;
                try {
                    savedValue = Number(
                        localStorage.getItem(difficultyStorageKey),
                    );
                } catch (error) {
                    savedValue = 1;
                }

                currentDifficulty = clampDifficulty(savedValue);
                difficultyInput.value = String(currentDifficulty);
                difficultyValue.textContent = String(currentDifficulty);
            }

            function saveDifficulty(level) {
                try {
                    localStorage.setItem(difficultyStorageKey, String(level));
                } catch (error) {
                    // Ignore storage errors and continue without persistence.
                }
            }

            function chooseOperator() {
                const randomChoice = Math.random() < 0.5 ? "+" : "-";

                if (recentOperators.length >= 2) {
                    const last = recentOperators[recentOperators.length - 1];
                    const prev = recentOperators[recentOperators.length - 2];
                    if (last === prev) {
                        return last === "+" ? "-" : "+";
                    }
                }

                return randomChoice;
            }

            function generateProblem(level) {
                const op = chooseOperator();
                let a = 0;
                let b = 0;

                if (level === 1) {
                    if (op === "+") {
                        a = randomInt(1, 10);
                        b = randomInt(2, 10);
                    } else {
                        a = randomInt(2, 10);
                        b = randomInt(1, a);
                    }
                } else if (level === 2) {
                    if (op === "+") {
                        a = randomInt(1, 13);
                        b = randomInt(1, 13);
                    } else {
                        a = randomInt(6, 13);
                        b = randomInt(1, a);
                    }
                } else if (level === 3) {
                    if (op === "+") {
                        a = randomInt(4, 17);
                        b = randomInt(4, 17);
                    } else {
                        a = randomInt(7, 23);
                        b = randomInt(3, a);
                    }
                } else if (level === 4) {
                    a = randomInt(-300, 400);
                    b = randomInt(-300, 400);
                } else {
                    a = randomInt(-2000, 2000);
                    b = randomInt(-2000, 2000);
                }

                const answer = op === "+" ? a + b : a - b;
                currentProblem = { a, b, op, answer };

                recentOperators.push(op);
                if (recentOperators.length > 6) {
                    recentOperators.shift();
                }
            }

            function formatOperand(value) {
                return value < 0 ? "(" + value + ")" : String(value);
            }

            function renderProblem() {
                equationText.textContent =
                    formatOperand(currentProblem.a) +
                    " " +
                    currentProblem.op +
                    " " +
                    formatOperand(currentProblem.b) +
                    " =";
                answerInput.value = "";
                answerInput.focus();
            }

            function setFeedback(message, type) {
                clearTimeout(feedbackFadeTimer);
                clearTimeout(feedbackClearTimer);

                if (!message) {
                    feedbackText.textContent = "";
                    feedbackText.className = "feedback";
                    return;
                }

                feedbackText.textContent = message;
                feedbackText.className = "feedback " + type + " show";

                feedbackFadeTimer = setTimeout(() => {
                    feedbackText.classList.add("fade-out");
                }, 1700);

                feedbackClearTimer = setTimeout(() => {
                    feedbackText.textContent = "";
                    feedbackText.className = "feedback";
                }, 2000);
            }

            function nextProblem() {
                generateProblem(currentDifficulty);
                renderProblem();
            }

            function isWholeNumber(value) {
                return /^-?\d+$/.test(value);
            }

            function handleDifficultyChange() {
                currentDifficulty = clampDifficulty(
                    Number(difficultyInput.value),
                );
                difficultyInput.value = String(currentDifficulty);
                difficultyValue.textContent = String(currentDifficulty);
                saveDifficulty(currentDifficulty);
                setFeedback("", "");
                nextProblem();
            }

            difficultyInput.addEventListener("input", handleDifficultyChange);
            difficultyInput.addEventListener("change", handleDifficultyChange);

            problemForm.addEventListener("submit", (event) => {
                event.preventDefault();
                const raw = answerInput.value.trim();

                if (!isWholeNumber(raw)) {
                    setFeedback("Try again", "error");
                    answerInput.value = "";
                    answerInput.focus();
                    return;
                }

                const guess = Number(raw);

                if (guess === currentProblem.answer) {
                    setFeedback("Good job!", "success");
                    nextProblem();
                } else {
                    setFeedback("Try again", "error");
                    answerInput.value = "";
                    answerInput.focus();
                }
            });

            loadSavedDifficulty();
            nextProblem();
        </script>
    </body>
</html>
